# CURRENT Priorities: CIPS Development

# CURRENT Priorities: CIPS Development

**Date:** 2025-04-03 *(Updated)*

## 1. Purpose & Context

This document outlines the immediate, actionable priorities for the CLAN.com Integrated Promotion System (CIPS) project. Its purpose is to guide day-to-day development work and provide a quick onboarding reference for collaborators (human or AI) regarding the current focus.

It bridges the gap between:

* The **Overall Project Plan:** (`Project Plan CIPS.md` - outlining long-term vision, phases, and goals).
* The **Technical Briefing:** (`Technical Briefing CIPS.md` - detailing the current tech stack, architecture, and key file functions).

This document should be updated frequently as tasks are completed and new priorities emerge.

## 2. Current High-Level Focus

* **Finalize Blog Publishing MVP:** Ensure the core workflow from content creation/management in the Admin UI to reliably publishing the Eleventy-built blog via `clan.com` deployment script is robust and **status-tracked**. *(Status tracking is next)*
* **Initiate Syndication MVP:** Implement the first basic social media syndication channel (Facebook). *(On hold until blog MVP is fully done)*

## 3. Actionable Priorities & Tasks

**Priority 1: Refine Blog Deployment Script (`scripts/post_to_clan.py`)**

* **Goal:** Ensure robust, secure, and clear deployment to `clan.com`.
* **Status:** **Largely Complete.** The script now uses the original logic, incorporates required HTML processing, loads config from `.env`, handles create/edit, and provides success/error output.
* **Tasks:**

  * [X] Review/Fix Credential Handling (No Hardcoding!) in `scripts/post_to_clan.py`. (Using `.env` now)

  * [/] Enhance Error Handling (Connection, Permissions, File Transfer etc.) in `scripts/post_to_clan.py`. (Improved with `requests` exceptions, could be more granular)
  * [/] Improve Logging Output in `scripts/post_to_clan.py` for better debugging via API response. (Significantly improved with `logging`)

  * [ ] Assess/Implement Idempotency (rsync-like behavior) in `scripts/post_to_clan.py` to only sync changed files if feasible. *(Deferred)*
  * [X] Review `scripts/post_to_clan.py` logic for clarity and maintainability. (Done during rewrite based on old script)

**Priority 2: Integrate Deployment Status Update into Workflow**

* **Goal:** Automatically update `_data/workflow_status.json` on deployment success/failure.
* **Status:** **Next Immediate Priority.** The script now provides the necessary success/failure info, but `app.py` needs to act on it.
* **Tasks:**
  * [ ] Modify `/api/publish_clan/<slug>` route in `app.py`.
  * [ ] Add logic to check the `success` flag (return code) from the `subprocess.run` call to `scripts/post_to_clan.py`.
  * [ ] Call `save_json_data` helper to update `stages.publishing_clancom.status` field in `_data/workflow_status.json` to `'complete'` or `'error'`.
  * [ ] Consider storing relevant error messages or script output snippets in `_data/workflow_status.json` on failure (using `last_error` field, as the script already does internally).

**Priority 3: Clarify Watermarked Image Handling & Deployment**

* **Goal:** Ensure clarity and consistency regarding which images (original vs. watermarked) are used where and deployed correctly.
* **Status:** **Pending.** Requires decisions and potentially minor script updates *after* Priority 2 is done.
* **Tasks:**
  * [ ] Determine & Document the exact output location/naming convention used by `scripts/watermark_images.py`.
  * [ ] Decide & Confirm: Should `scripts/post_to_clan.py`'s `upload_image_to_clan` function upload *original* or *watermarked* images? *(Currently uploads originals based on `image_library.json`)*.
  * [ ] Update `upload_image_to_clan` logic if watermarked images need to be uploaded instead.
  * [X] Verify the Eleventy `{% image %}` shortcode in `.eleventy.js` consistently uses the *original* source images for the main blog build process. *(Confirmed during previous analysis)*.

**Priority 4: Improve Admin UX for Manual Status Updates (Optional but Recommended)**

* **Goal:** Allow easier manual status updates via the Admin UI, especially for steps like watermarking before full automation.
* **Status:** **Optional / Deferred.** Can be done after core functionality is stable.
* **Tasks:**
  * [ ] Add HTML buttons/links around relevant status indicators in `templates/admin_post_detail.html`.
  * [ ] Add JavaScript listeners to handle clicks on these elements.
  * [ ] Implement JS logic to determine the target `slug`, `stage_key` (including nested keys like `images.watermarks.<image_id>`), and the desired *next* status value.
  * [ ] Implement JS `fetch` POST request to `/api/update_status/<slug>/<stage_key>` with the new status.
  * [ ] Add JS logic to visually update the UI element upon successful API response.

**Priority 5: Implement Facebook Syndication (MVP)**

* **Goal:** Achieve basic publishing of a post (title, link, key image) to a designated Facebook Page.
* **Status:** **Planned.** To be started after Priority 2 (and potentially Priority 3 decisions) are complete.
* **Tasks:**
  * [ ] Research & Setup: Obtain Facebook Graph API credentials for posting to a Page. Implement secure storage for API keys/tokens (e.g., environment variables, config file outside Git).
  * [ ] Develop Python function/script (e.g., in a new `scripts/syndication_utils.py` or dedicated `scripts/syndicate_facebook.py`) to handle:
    * Accepting post details (slug, title, URL, image path).
    * Formatting a basic Facebook post.
    * Calling the Facebook Graph API.
    * Returning success/failure and any relevant data (e.g., Facebook Post ID).
  * [ ] Create a new API endpoint in `app.py` (e.g., `/api/syndicate/facebook/<slug>`) that:
    * Calls the Facebook syndication function/script.
    * Handles success/failure response.
  * [ ] Add logic to the new API endpoint to update `_data/workflow_status.json` (e.g., set `stages.syndication.facebook.status` to `'complete'`/`'error'` and store `postId`). Use the `save_json_data` helper.
  * [ ] Add a basic "Post to Facebook" button in `templates/admin_post_detail.html` that triggers the new API endpoint via JavaScript.

---

*This document should be updated by checking off completed tasks and adding/refining priorities as development proceeds.

**Date:** 2025-04-02 *(Please update date as work progresses)*

## 1. Purpose & Context

This document outlines the immediate, actionable priorities for the CLAN.com Integrated Promotion System (CIPS) project. Its purpose is to guide day-to-day development work and provide a quick onboarding reference for collaborators (human or AI) regarding the current focus.

It bridges the gap between:

* The **Overall Project Plan:** (`Project Plan CIPS.md` - outlining long-term vision, phases, and goals).
* The **Technical Briefing:** (`Technical Briefing CIPS.md` - detailing the current tech stack, architecture, and key file functions).

This document should be updated frequently as tasks are completed and new priorities emerge.

## 2. Current High-Level Focus

* **Finalize Blog Publishing MVP:** Ensure the core workflow from content creation/management in the Admin UI to reliably publishing the Eleventy-built blog via `clan.com` deployment script is robust and status-tracked.
* **Initiate Syndication MVP:** Implement the first basic social media syndication channel (Facebook).

## 3. Actionable Priorities & Tasks

**Priority 1: Refine Blog Deployment Script (`scripts/post_to_clan.py`)**

* **Goal:** Ensure robust, secure, and clear deployment to `clan.com`.
* **Tasks:**
  * [ ] Review/Fix Credential Handling (No Hardcoding!) in `scripts/post_to_clan.py`. Prioritize SSH keys via Paramiko or secure environment variables.
  * [ ] Enhance Error Handling (Connection, Permissions, File Transfer etc.) in `scripts/post_to_clan.py`.
  * [ ] Improve Logging Output in `scripts/post_to_clan.py` for better debugging via API response.
  * [ ] Assess/Implement Idempotency (rsync-like behavior) in `scripts/post_to_clan.py` to only sync changed files if feasible.
  * [ ] Review `scripts/post_to_clan.py` logic for clarity and maintainability.

**Priority 2: Integrate Deployment Status Update into Workflow**

* **Goal:** Automatically update `_data/workflow_status.json` on deployment success/failure.
* **Tasks:**
  * [ ] Modify `/api/publish_clan/<slug>` route in `app.py`.
  * [ ] Add logic to check the `success` flag (return code) from the `subprocess.run` call to `scripts/post_to_clan.py`.
  * [ ] Call `save_json_data` helper to update `stages.publishing_clancom.status` field in `_data/workflow_status.json` to `'complete'` or `'error'`.
  * [ ] Consider storing relevant error messages or script output snippets in `_data/workflow_status.json` on failure.

**Priority 3: Clarify Watermarked Image Handling & Deployment**

* **Goal:** Ensure clarity and consistency regarding which images (original vs. watermarked) are used where and deployed correctly.
* **Tasks:**
  * [ ] Determine & Document the exact output location/naming convention used by `scripts/watermark_images.py`.
  * [ ] Decide & Confirm: Should `scripts/post_to_clan.py` deploy *original* or *watermarked* images to `clan.com`? *(Consider: Are watermarks needed on the live blog?)*
  * [ ] Update the image source path logic within `scripts/post_to_clan.py` based on the decision above.
  * [ ] Verify the Eleventy `{% image %}` shortcode in `.eleventy.js` consistently uses the *original* source images for the main blog build process.

**Priority 4: Improve Admin UX for Manual Status Updates (Optional but Recommended)**

* **Goal:** Allow easier manual status updates via the Admin UI, especially for steps like watermarking before full automation.
* **Tasks:**
  * [ ] Add HTML buttons/links around relevant status indicators in `templates/admin_post_detail.html`.
  * [ ] Add JavaScript listeners to handle clicks on these elements.
  * [ ] Implement JS logic to determine the target `slug`, `stage_key` (including nested keys like `images.watermarks.<image_id>`), and the desired *next* status value.
  * [ ] Implement JS `fetch` POST request to `/api/update_status/<slug>/<stage_key>` with the new status.
  * [ ] Add JS logic to visually update the UI element upon successful API response.

**Priority 5: Implement Facebook Syndication (MVP)**

* **Goal:** Achieve basic publishing of a post (title, link, key image) to a designated Facebook Page.
* **Tasks:**
  * [ ] Research & Setup: Obtain Facebook Graph API credentials for posting to a Page. Implement secure storage for API keys/tokens (e.g., environment variables, config file outside Git).
  * [ ] Develop Python function/script (e.g., in a new `scripts/syndication_utils.py` or dedicated `scripts/syndicate_facebook.py`) to handle:
    * Accepting post details (slug, title, URL, image path).
    * Formatting a basic Facebook post.
    * Calling the Facebook Graph API.
    * Returning success/failure and any relevant data (e.g., Facebook Post ID).
  * [ ] Create a new API endpoint in `app.py` (e.g., `/api/syndicate/facebook/<slug>`) that:
    * Calls the Facebook syndication function/script.
    * Handles success/failure response.
  * [ ] Add logic to the new API endpoint to update `_data/workflow_status.json` (e.g., set `stages.syndication.facebook.status` to `'complete'`/`'error'` and store `postId`). Use the `save_json_data` helper.
  * [ ] Add a basic "Post to Facebook" button in `templates/admin_post_detail.html` that triggers the new API endpoint via JavaScript.

---

*This document should be updated by checking off completed tasks and adding/refining priorities as development proceeds.*
