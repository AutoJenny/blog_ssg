# CURRENT Priorities: CIPS Development

**Date:** 2025-04-03 *(Updated)*

## 1. Purpose & Context

This document outlines the immediate, actionable priorities for the CLAN.com Integrated Promotion System (CIPS) project. Its purpose is to guide day-to-day development work and provide a quick onboarding reference for collaborators (human or AI) regarding the current focus.

It bridges the gap between:
*   The **Overall Project Plan:** (`Project Plan CIPS.md` - outlining long-term vision, phases, and goals).
*   The **Technical Briefing:** (`Technical Briefing CIPS.md` - detailing the current tech stack, architecture, and key file functions).

This document should be updated frequently as tasks are completed and new priorities emerge.

## 2. Current High-Level Focus

*   **Finalize Blog Publishing MVP:** Ensure the core workflow from content creation/management in the Admin UI to reliably publishing the Eleventy-built blog via `clan.com` deployment script is robust and status-tracked. **(MVP Achieved!)**
*   **Initiate Syndication MVP:** Implement the first basic social media syndication channel (Facebook). *(Now the primary focus)*

## 3. Actionable Priorities & Tasks

**Priority 1: Refine Blog Deployment Script (`scripts/post_to_clan.py`)**

*   **Goal:** Ensure robust, secure, and clear deployment to `clan.com`.
*   **Status:** **Complete.** (Incorporates original logic, .env config, required HTML processing, image uploads based on new workflow, API interaction, status reporting).
*   **Tasks:**
    *   [X] Review/Fix Credential Handling (No Hardcoding!) in `scripts/post_to_clan.py`. (Using `.env` now)
    *   [X] Enhance Error Handling (Connection, Permissions, File Transfer etc.) in `scripts/post_to_clan.py`. (Incorporated from original script, uses requests exceptions)
    *   [X] Improve Logging Output in `scripts/post_to_clan.py` for better debugging via API response. (Incorporated from original script)
    *   [ ] Assess/Implement Idempotency (rsync-like behavior) in `scripts/post_to_clan.py` to only sync changed files if feasible. *(Deferred - Low Priority)*
    *   [X] Review `scripts/post_to_clan.py` logic for clarity and maintainability. (Done during integration)

**Priority 2: Integrate Deployment Status Update into Workflow**

*   **Goal:** Automatically update `_data/workflow_status.json` on deployment success/failure.
*   **Status:** **Complete.** (`app.py`'s `/api/publish_clan` route now loads/saves status, including extracted Post ID).
*   **Tasks:**
    *   [X] Modify `/api/publish_clan/<slug>` route in `app.py`.
    *   [X] Add logic to check the `success` flag (return code) from the `subprocess.run` call to `scripts/post_to_clan.py`.
    *   [X] Call `save_json_data` helper to update `stages.publishing_clancom.status` field in `_data/workflow_status.json` to `'complete'` or `'error'`.
    *   [X] Consider storing relevant error messages or script output snippets in `_data/workflow_status.json` on failure (using `last_error` field). (Implemented)

**Priority 3: Standardize Image Handling & Deployment** *(Revised Goal)*

*   **Goal:** Implement a structured workflow for importing, processing (optimizing, watermarking), storing, and deploying images.
*   **Status:** **Complete.** (New script `process_imported_image.py` handles this; `post_to_clan.py` correctly uploads the processed 'published' version).
*   **Tasks:**
    *   [X] Create Image Import Workflow (`_SOURCE_MEDIA/`, `scripts/process_imported_image.py`).
    *   [X] `process_imported_image.py` saves raw, optimized/published (WebP), and watermarked versions.
    *   [X] `process_imported_image.py` updates `image_library.json` with paths.
    *   [X] Decide & Confirm: `scripts/post_to_clan.py` uploads the **published (optimized, unwatermarked)** image. *(Decision implemented)*.
    *   [X] Update `scripts/post_to_clan.py`'s `upload_image_to_clan` and related functions to use `published_file_path` from `image_library.json`. *(Done)*.
    *   [X] Verify the Eleventy `{% image %}` shortcode uses the correct published images. *(Assumed working based on previous checks and standard Eleventy usage)*.

**Priority 4: Improve Admin UX for Manual Status Updates (Optional but Recommended)**

*   **Goal:** Allow easier manual status updates via the Admin UI.
*   **Status:** **Optional / Deferred.**
*   **Tasks:** (No change - still pending if desired)
    *   [ ] Add HTML buttons/links around relevant status indicators in `templates/admin_post_detail.html`.
    *   [ ] Add JavaScript listeners to handle clicks on these elements.
    *   [ ] Implement JS logic to determine the target `slug`, `stage_key` (including nested keys like `images.watermarks.<image_id>`), and the desired *next* status value.
    *   [ ] Implement JS `fetch` POST request to `/api/update_status/<slug>/<stage_key>` with the new status.
    *   [ ] Add JS logic to visually update the UI element upon successful API response.

**Priority 5: Implement Facebook Syndication (MVP)**

*   **Goal:** Achieve basic publishing of a post (title, link, key image) to a designated Facebook Page.
*   **Status:** **Planned - NEXT MAJOR PRIORITY.**
*   **Tasks:** (Ready to start)
    *   [ ] Research & Setup: Obtain Facebook Graph API credentials for posting to a Page. Implement secure storage for API keys/tokens (e.g., `.env` file).
    *   [ ] Develop Python function/script (e.g., in a new `scripts/syndication_utils.py` or dedicated `scripts/syndicate_facebook.py`) to handle:
        * Accepting post details (slug, title, URL, path to **published image**).
        * Formatting a basic Facebook post (e.g., message with link, potentially uploading the image).
        * Calling the Facebook Graph API.
        * Returning success/failure and any relevant data (e.g., Facebook Post ID).
    *   [ ] Create a new API endpoint in `app.py` (e.g., `/api/syndicate/facebook/<slug>`) that:
        * Calls the Facebook syndication function/script.
        * Handles success/failure response.
    *   [ ] Add logic to the new API endpoint to update `_data/workflow_status.json` (e.g., set `stages.syndication.facebook.status` to `'complete'`/`'error'` and store `postId`). Use the `save_json_data` helper.
    *   [ ] Add a basic "Post to Facebook" button in `templates/admin_post_detail.html` that triggers the new API endpoint via JavaScript.

---

*This document should be updated by checking off completed tasks and adding/refining priorities as development proceeds.*