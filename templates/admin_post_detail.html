<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {# Title uses metadata passed from Flask #}
    <title>Manage: {{ post.title | default('Unknown Post') }} - Blog Workflow</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #333333;
            --border-color: #ccc;
            --post-bg: #ffffff;
            --post-border: #ddd;
            --log-bg: #f8f8f8;
            --help-bg: #ffffe0;
            --code-bg: #eee;
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --border-color: #444;
            --post-bg: #2d2d2d;
            --post-border: #444;
            --log-bg: #2d2d2d;
            --help-bg: #2d2d2d;
            --code-bg: #3d3d3d;
        }

        /* --- Base & General Styles --- */
        body { 
            font-family: sans-serif; 
            padding: 20px; 
            max-width: 900px; 
            margin: auto; 
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        h1, h2, h3 { 
            border-bottom: 1px solid var(--border-color); 
            padding-bottom: 5px; 
            margin-bottom: 15px; 
            color: var(--text-color); 
        }
        h1 { font-size: 1.8em; }
        h2 { font-size: 1.4em; margin-top: 2em; }
        h3 { font-size: 1.1em; border-bottom: 1px dotted var(--border-color); margin-top: 1.5em;}
        small { font-size: 0.85em; }
        hr { border: none; border-top: 1px solid var(--border-color); margin: 1em 0; }
        textarea[readonly] { cursor: default; background-color: var(--log-bg) !important; }
        .back-link { margin-bottom: 20px; display: block; font-size: 0.9em; }
        code { background-color: var(--code-bg); padding: 0.1em 0.4em; border-radius: 3px; font-size: 0.95em; }

        /* --- Traffic Light Styles --- */
        .traffic-light { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; vertical-align: middle; border: 1px solid rgba(0,0,0,0.1); }
        .traffic-light[data-status="pending"] { background-color: #ccc; }
        .traffic-light[data-status="partial"] { background-color: #f0ad4e; }
        .traffic-light[data-status="complete"] { background-color: #5cb85c; }
        .traffic-light[data-status="error"] { background-color: #d9534f; }

        /* --- Collapsible Section Styles --- */
        .workflow-stage summary { 
            padding: 10px 15px; 
            background-color: var(--post-bg); 
            cursor: pointer; 
            font-weight: bold; 
            outline: none; 
            display: flex; 
            align-items: center; 
            border-radius: 3px; 
            transition: background-color 0.2s ease-out; 
        }
        .workflow-stage[open] summary { 
            border-bottom: 1px solid var(--post-border); 
            background-color: var(--post-bg); 
            border-bottom-left-radius: 0; 
            border-bottom-right-radius: 0; 
        }
        div.stage-content { 
            padding: 20px; 
            border: 1px solid var(--post-border); 
            border-top: none; 
            background-color: var(--post-bg); 
            border-bottom-left-radius: 3px; 
            border-bottom-right-radius: 3px; 
        }
        div.stage-content p { margin-bottom: 0.8em; line-height: 1.5; }
        div.stage-content p:last-child { margin-bottom: 0; }
        div.stage-content .status-text { font-weight: bold; }

        /* --- Help System Styles --- */
        .help-trigger { 
            display: inline-block; 
            width: 16px; 
            height: 16px; 
            line-height: 16px; 
            margin-left: 6px; 
            font-size: 11px; 
            font-weight: bold; 
            text-align: center; 
            color: #fff; 
            background-color: #0d6efd; 
            border-radius: 50%; 
            cursor: pointer; 
            user-select: none; 
            vertical-align: middle; 
            transition: background-color 0.2s ease; 
        }
        .help-trigger:hover { background-color: #0a58ca; }
        .help-content { 
            display: none; 
            position: absolute; 
            background-color: var(--help-bg); 
            border: 1px solid var(--border-color); 
            border-radius: 4px; 
            padding: 10px 15px; 
            box-shadow: 2px 2px 5px rgba(0,0,0,0.15); 
            z-index: 10; 
            margin-left: 5px; 
            margin-top: -5px; 
            width: 350px; 
            font-size: 0.9em; 
            line-height: 1.5; 
            letter-spacing: normal; 
            text-align: left; 
        }
        .help-content p, .help-content ul, .help-content ol { margin-bottom: 0.8em; letter-spacing: normal; }
        .help-content ul, .help-content ol { padding-left: 1.5em; }
        .help-content code { background-color: var(--code-bg); padding: 0.1em 0.3em; border-radius: 2px; font-size: 0.95em; }
        .help-content.active { display: block; }
        h2 > .help-trigger { vertical-align: baseline; }

        /* --- Log Output Styles --- */
        #log-output { 
            margin-top: 20px; 
            padding: 10px; 
            border: 1px solid var(--border-color); 
            background-color: var(--log-bg); 
            min-height: 100px; 
            white-space: pre-wrap; 
            font-family: monospace; 
            font-size: 0.9em; 
            max-height: 300px; 
            overflow-y: auto; 
            border-radius: 3px;
        }
        #log-output div { margin-bottom: 2px; line-height: 1.3; border-bottom: 1px dotted var(--border-color); padding-bottom: 2px; }
        #log-output div:last-child { border-bottom: none; }
        #log-output div.log-error { color: #dc3545; }

        /* --- Theme Toggle Styles --- */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 32px;
            height: 32px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
            transition: transform 0.3s ease;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        .theme-toggle::before {
            content: '‚òÄÔ∏è';
            font-size: 20px;
        }

        [data-theme="dark"] .theme-toggle::before {
            content: 'üåô';
        }
    </style>
</head>
<body>
    <button class="theme-toggle" id="themeToggle" title="Toggle dark/light mode"></button>
    <div class="container"> {# Wrap content in container for Bootstrap #}
        <p class="back-link mt-3"><a href="{{ url_for('index') }}">‚Üê Back to Post List</a></p>

        <h1>Manage: {{ post.title | default('Post Details') }}</h1>
        <p><strong>Slug:</strong> <code>{{ slug }}</code>
            <a href="vscode://file/{{ config.BASE_DIR_STR }}/posts/{{ slug }}.md" title="Edit Markdown File in VS Code" class="ms-2">
                <i class="bi bi-pencil-square"></i> (Edit MD)
            </a>
         </p>

         <section id="workflow-stages">
            <h2>Workflow Stages <span class="help-trigger" data-help-id="manage-posts-main-help" title="Help for Manage Posts Section">?</span></h2>
             <div class="help-content" id="manage-posts-main-help">{% include 'help/manage_posts_help.njk' %}</div>
    
            {# --- Stage I: Conceptualisation --- #}
            <details class="workflow-stage" data-stage-key="conceptualisation">
                <summary>
                    <span class="traffic-light" data-status="{{ status.stages.conceptualisation.status | default('pending') }}"></span>
                    I. Conceptualisation
                </summary>
                <div class="stage-content">
                    <div class="mb-3">
                        <label for="concept" class="form-label">Core Idea</label>
                        <textarea class="form-control" id="concept" rows="3" data-field="concept">{{ post.concept | default('') }}</textarea>
                        <div class="form-text">The core idea or concept of the post</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="title" value="{{ post.title | default('') }}" data-field="title">
                        <div class="form-text">The main title of the post</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="subtitle" class="form-label">Subtitle</label>
                        <input type="text" class="form-control" id="subtitle" value="{{ post.subtitle | default('') }}" data-field="subtitle">
                        <div class="form-text">A brief subtitle or description</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="slug" class="form-label">URL Slug</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="slug" value="{{ slug }}" data-field="slug" {% if status.stages.publishing_clancom.status == 'complete' %}readonly{% endif %}>
                            <button class="btn btn-outline-secondary" type="button" id="edit-slug" {% if status.stages.publishing_clancom.status == 'complete' %}disabled{% endif %}>
                                <i class="bi bi-pencil"></i>
                            </button>
                        </div>
                        <div class="form-text">
                            {% if status.stages.publishing_clancom.status == 'complete' %}
                                <span class="text-warning"><i class="bi bi-exclamation-triangle-fill"></i> Warning: This post has been published. Changing the slug may break existing links.</span>
                            {% else %}
                                The URL-friendly version of the title. Can only be changed before publication.
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <button type="button" class="btn btn-primary" id="save-metadata">Save Changes</button>
                        <span class="ms-2 text-muted" id="save-status"></span>
                    </div>

                    <p>
                        <strong>Status:</strong> <code class="status-text">{{ status.stages.conceptualisation.status | default('pending') }}</code>
                        {% set current_status = status.stages.conceptualisation.status | default('pending') %}
                        {% if current_status != 'complete' %}<button class="status-update-button btn btn-sm btn-outline-success ms-2" data-slug="{{ slug }}" data-stage="conceptualisation" data-new-status="complete" title="Mark this stage as fully complete">Mark Complete</button>{% endif %}
                        {% if current_status != 'pending' %}<button class="status-update-button btn btn-sm btn-outline-secondary ms-2" data-slug="{{ slug }}" data-stage="conceptualisation" data-new-status="pending" title="Reset status to pending">Mark Pending</button>{% endif %}
                    </p>
                </div>
            </details>
    
            {# --- Stage II: Authoring --- #}
            <details class="workflow-stage" data-stage-key="authoring">
                <summary>
                    <span class="traffic-light" data-status="{{ status.stages.authoring.status | default('pending') }}"></span>
                    II. Content Authoring & Structuring
                </summary>
                <div class="stage-content">
                    <div class="mb-4">
                        <h3>Summary</h3>
                        <div class="mb-3">
                            <label for="summary" class="form-label">Post Summary</label>
                            <textarea class="form-control" id="summary" rows="3" data-field="summary">{{ post.summary | default('') }}</textarea>
                            <div class="form-text">A brief summary of the post that will appear at the top</div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h3>Content Sections</h3>
                        <div id="sections-container">
                            {% if post.sections %}
                                {% for section in post.sections %}
                                <div class="section-item mb-4 p-3 border rounded" data-section-index="{{ loop.index0 }}">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h4 class="mb-0">Section {{ loop.index }}</h4>
                                        <button type="button" class="btn btn-sm btn-outline-danger delete-section" data-section-index="{{ loop.index0 }}">
                                            <i class="bi bi-trash"></i> Delete
                                        </button>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Heading</label>
                                        <input type="text" class="form-control section-heading" value="{{ section.heading | default('') }}" data-field="heading">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Content</label>
                                        <textarea class="form-control section-content" rows="5" data-field="text">{{ section.text | default('') }}</textarea>
                                        <div class="form-text">Use HTML tags for formatting (p, b, i, ul, li)</div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        <button type="button" class="btn btn-outline-primary" id="add-section">
                            <i class="bi bi-plus-circle"></i> Add Section
                        </button>
                    </div>

                    <div class="mb-4">
                        <h3>Conclusion</h3>
                        <div class="mb-3">
                            <label for="conclusion-heading" class="form-label">Conclusion Heading</label>
                            <input type="text" class="form-control" id="conclusion-heading" value="{{ post.conclusion.heading | default('') }}" data-field="conclusion.heading">
                        </div>
                        <div class="mb-3">
                            <label for="conclusion-text" class="form-label">Conclusion Text</label>
                            <textarea class="form-control" id="conclusion-text" rows="3" data-field="conclusion.text">{{ post.conclusion.text | default('') }}</textarea>
                            <div class="form-text">Use HTML tags for formatting (p, b, i, ul, li)</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <button type="button" class="btn btn-primary" id="save-content">Save Content</button>
                        <span class="ms-2 text-muted" id="save-content-status"></span>
                    </div>

                    <p>
                        <strong>Status:</strong> <code class="status-text">{{ status.stages.authoring.status | default('pending') }}</code>
                        {% set current_status = status.stages.authoring.status | default('pending') %}
                        {% if current_status != 'complete' %}<button class="status-update-button btn btn-sm btn-outline-success ms-2" data-slug="{{ slug }}" data-stage="authoring" data-new-status="complete" title="Mark this stage as fully complete">Mark Complete</button>{% endif %}
                        {% if current_status != 'pending' %}<button class="status-update-button btn btn-sm btn-outline-secondary ms-2" data-slug="{{ slug }}" data-stage="authoring" data-new-status="pending" title="Reset status to pending">Mark Pending</button>{% endif %}
                    </p>
                    <p><strong>HTML Formatting Status:</strong> <span class="traffic-light" data-status="{{ status.stages.authoring.text_format_status | default('pending') }}"></span> <code class="status-text">{{ status.stages.authoring.text_format_status | default('pending') }}</code></p>
                </div>
            </details>
    
            {# --- Stage III: Metadata & File Setup --- #}
            <details class="workflow-stage" data-stage-key="metadata">
                <summary>
                    <span class="traffic-light" data-status="{{ status.stages.metadata.status | default('pending') }}"></span>
                    III. Metadata & File Setup
                </summary>
                <div class="stage-content">
                    <p>Create the `.md` file and populate YAML front matter (Title, Subtitle, Description, Date, Author Key, Tags, Content Placeholders).</p>
                    <p>
                        <strong>Overall Status:</strong> <code class="status-text">{{ status.stages.metadata.status | default('pending') }}</code>
                         {% set current_status = status.stages.metadata.status | default('pending') %}
                         {% if current_status != 'complete' %}<button class="status-update-button btn btn-sm btn-outline-success ms-2" data-slug="{{ slug }}" data-stage="metadata" data-new-status="complete" title="Mark this stage as fully complete">Mark Complete</button>{% endif %}
                         {% if current_status != 'pending' %}<button class="status-update-button btn btn-sm btn-outline-secondary ms-2" data-slug="{{ slug }}" data-stage="metadata" data-new-status="pending" title="Reset status to pending">Mark Pending</button>{% endif %}
                    </p>
                    <p><strong>Front Matter Populated:</strong> <span class="traffic-light" data-status="{{ status.stages.metadata.front_matter_status | default('pending') }}"></span> <code class="status-text">{{ status.stages.metadata.front_matter_status | default('pending') }}</code></p>
                    <p><strong>Tags Defined:</strong> <span class="traffic-light" data-status="{{ status.stages.metadata.tags_status | default('pending') }}"></span> <code class="status-text">{{ status.stages.metadata.tags_status | default('pending') }}</code></p>
                    <p><strong>Author Assigned:</strong> <span class="traffic-light" data-status="{{ status.stages.metadata.author_status | default('pending') }}"></span> <code class="status-text">{{ status.stages.metadata.author_status | default('pending') }}</code></p>
                    <hr>
                     <p><i>Title: {{ post.title }}</i></p>
                     <p><i>Author Key: {{ post.author }}</i></p>
                     <p><i>Tags: {{ post.tags | join(', ') }}</i></p>
                </div>
            </details>
    
            {# --- Stage IV: Image Workflow --- #}
            <details class="workflow-stage" data-stage-key="images">
                <summary>
                    <span class="traffic-light" data-status="{{ status.stages.images.status | default('pending') }}"></span>
                    IV. Image Workflow
                </summary>
                <div class="stage-content">

                    {# --- Informational Text about New Workflow --- #}
                    <div class="alert alert-info small" role="alert">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        Image processing (optimization to WEBP, watermarking) is now handled by running the
                        <code>scripts/process_imported_image.py</code> script manually from the command line for each new image placed in
                        <code>_SOURCE_MEDIA/_IMPORT_IMAGES/</code>. This script updates the Image Library and creates the necessary published and watermarked files.
                        Statuses below reflect the data recorded in the Image Library and Workflow files.
                    </div>
                    {# --- End Informational Text --- #}

                    {# Status line WITHOUT old Watermark All button #}
                    <div class="d-flex justify-content-between align-items-center p-2 mb-3 bg-light rounded flex-wrap">
                        <span class="me-3 mb-1 mb-md-0">
                            <strong>Overall Image Status:</strong> <code class="status-text">{{ status.stages.images.status | default('pending') }}</code>
                            {# Optionally add clickable status updates here later #}
                        </span>
                        {# Optional Manual Override Buttons for Overall Stage #}
                        <span>
                            {% set current_status = status.stages.images.status | default('pending') %}
                            {% if current_status != 'complete' %}
                                <button class="status-update-button btn btn-sm btn-outline-success ms-2" data-slug="{{ slug }}" data-stage="images" data-new-status="complete" title="Mark this stage as fully complete (Manual Override)">Mark Complete</button>
                            {% endif %}
                            {% if current_status != 'pending' %}
                                <button class="status-update-button btn btn-sm btn-outline-secondary ms-2" data-slug="{{ slug }}" data-stage="images" data-new-status="pending" title="Reset status to pending">Mark Pending</button>
                            {% endif %}
                        </span>
                    </div>

                    {# Display Calculated Sub-Statuses #}
                    <p class="mb-1"><small>
                        Prompts Defined: <span class="traffic-light" data-status="{{ status.stages.images.prompts_defined_status | default('pending') }}"></span>
                        | Assets Prepared: <span class="traffic-light" data-status="{{ status.stages.images.assets_prepared_status | default('pending') }}"></span>
                        | Metadata Integrated: <span class="traffic-light" data-status="{{ status.stages.images.metadata_integrated_status | default('pending') }}"></span>
                        {# Add clickable triggers here later if desired #}
                    </small></p>


                    {# --- Loop through detailed image list passed from Flask --- #}
                    {% if images_detailed %}
                    <ul class="image-detail-list list-unstyled mt-3"> {# Added mt-3 #}
                    {% for img_info in images_detailed %}
                    {# --- Start of individual image item --- #}
                    <li class="mb-3 p-3 border rounded">
                        <div class="d-flex flex-column flex-md-row align-items-md-start">

                            {# --- Left Column: Metadata --- #}
                            <div class="flex-grow-1 me-md-3">

                                {% if img_info.error %}
                                    <p class="text-danger mb-0"><strong>Error:</strong> Image ID <code>{{ img_info.id }}</code> - {{ img_info.error }}</p>
                                {% else %}
                                    {# ID and Description #}
                                    <p class="mb-1">
                                        <code>{{ img_info.id }}</code> :
                                        {% set original_desc = img_info.description %}
                                        {% set sep_section = ' section image for ' %}{% set sep_header = ' header image for ' %}{% set sep_conclusion = ' conclusion image for ' %}
                                        {% if sep_section in original_desc %}{% set cleaned_desc = original_desc.split(sep_section, 1)[0] %}
                                        {% elif sep_header in original_desc %}{% set cleaned_desc = original_desc.split(sep_header, 1)[0] %}
                                        {% elif sep_conclusion in original_desc %}{% set cleaned_desc = original_desc.split(sep_conclusion, 1)[0] %}
                                        {% else %}{% set cleaned_desc = original_desc %}{% endif %}
                                        <strong>{{ cleaned_desc | trim | default('(No Description)') }}</strong>
                                    </p>

                                    {# Filename #}
                                    <p class="mb-1"><small>
                                        <strong>Filename (Published):</strong> <code>{{ img_info.filename_local | default('N/A') }}</code> {# Assumes filename_local is the published one #}
                                        {% if img_info.filename_local %}
                                            <a href="#" class="ms-1" onclick="navigator.clipboard.writeText('{{ img_info.filename_local }}'); alert('Filename copied!'); return false;" title="Copy Filename">
                                                <i class="bi bi-clipboard small"></i></a>
                                        {% endif %}
                                    </small></p>

                                    {# Public URL (Derived) #}
                                    {% if img_info.filename_local %}
                                        {% set public_url = "https://static.clan.com/media/blog/" + img_info.filename_local %} {# Derived URL #}
                                        <p class="mb-3"><small>
                                            <strong>Est. URL:</strong> <a href="{{ public_url }}" target="_blank">{{ public_url }}</a>
                                            <a href="#" class="ms-1" onclick="navigator.clipboard.writeText('{{ public_url }}'); alert('URL copied!'); return false;" title="Copy Public URL">
                                                <i class="bi bi-clipboard small"></i></a>
                                        </small></p>
                                    {% else %}<div class="mb-3"></div>{% endif %}

                                    {# Prompt #}
                                    <div class="mb-3">
                                        <p class="mb-1">
                                            <strong>Prompt:</strong> <span class="traffic-light" data-status="{{ img_info.prompt_status }}"></span> <code class="status-text">{{ img_info.prompt_status }}</code>
                                            {# Add clickable status here later #}
                                        </p>
                                        <textarea readonly class="form-control form-control-sm" style="min-height: 60px; font-size: 0.85em;">{{ img_info.prompt | default('No prompt defined.') }}</textarea>
                                    </div>

                                    {# Meta Alt #}
                                    <div class="mb-3">
                                         <p class="mb-1">
                                            <strong>Alt Text:</strong> <span class="traffic-light" data-status="{{ 'complete' if img_info.alt else 'pending' }}"></span> <code class="status-text">{{ 'complete' if img_info.alt else 'pending' }}</code>
                                            {# Add clickable status here later #}
                                         </p>
                                         <textarea readonly class="form-control form-control-sm" style="min-height: 40px; font-size: 0.85em;">{{ img_info.alt | default('(No alt text)') }}</textarea>
                                    </div>

                                    {# Caption #}
                                    <div class="mb-3">
                                        <p class="mb-1">
                                            <strong>Caption:</strong> <span class="traffic-light" data-status="{{ 'complete' if img_info.blog_caption else 'pending' }}"></span> <code class="status-text">{{ 'complete' if img_info.blog_caption else 'pending' }}</code>
                                            {# Add clickable status here later #}
                                        </p>
                                        <textarea readonly class="form-control form-control-sm" style="min-height: 40px; font-size: 0.85em;">{{ img_info.blog_caption | default('(No caption)') }}</textarea>
                                    </div>

                                    {# --- Individual Watermark Status --- #}
                                    <div class="mb-3">
                                        <p class="mb-0"> {# Reduced bottom margin #}
                                            <strong>Watermark Applied?:</strong>
                                            <span class="traffic-light" data-status="{{ img_info.watermarking_status | default('pending') }}"></span>
                                            <code class="status-text status-trigger"
                                                  data-slug="{{ slug }}"
                                                  data-stage-key="images.watermarks.{{ img_info.id }}"
                                                  style="cursor: pointer;" title="Click to cycle status (if JS implemented)">
                                                {{ img_info.watermarking_status | default('pending') }}
                                            </code>
                                            {# JS needed to make this clickable later (Priority 4) #}
                                        </p>
                                    </div>
                                    {# --- End Individual Watermark Status --- #}


                                    {# Notes #}
                                    {% if img_info.notes %}
                                    <div class="mb-0">
                                        <p class="mb-1"><strong>Notes:</strong></p>
                                         <textarea readonly class="form-control form-control-sm" style="min-height: 40px; font-size: 0.85em;">{{ img_info.notes }}</textarea>
                                    </div>
                                    {% endif %}

                                {% endif %} {# End of no error check #}
                            </div> {# End Left Column #}

                            {# --- Right Column: Image Thumbnail/Placeholder --- #}
                            <div class="flex-shrink-0 mt-3 mt-md-0" style="width: 250px; max-width: 100%;">
                                 {% if img_info.display_url %} {# Use display_url generated by app.py #}
                                    <img src="{{ img_info.display_url }}" alt="Thumbnail for {{ img_info.id }}" class="img-thumbnail w-100" style="max-width: 250px;">
                                 {% elif img_info.error %}
                                    <div class="border rounded bg-light d-flex align-items-center justify-content-center text-muted w-100" style="min-height: 150px; aspect-ratio: 16 / 9; max-width: 250px;">
                                        <span>Error Loading Image Info</span>
                                    </div>
                                 {% else %}
                                    <div class="border rounded bg-light d-flex align-items-center justify-content-center text-muted w-100" style="min-height: 150px; aspect-ratio: 16 / 9; max-width: 250px;">
                                        <span>Image Not Found / Not Processed</span>
                                    </div>
                                 {% endif %}
                            </div> {# End Right Column #}

                        </div> {# End Flex Container #}
                    </li> {# --- End of individual image item --- #}
                    {% endfor %}
                    </ul>
                    {% else %}
                    <p>No images referenced by this post.</p>
                    {% endif %}
                    {# --- END Image Loop Comment --- #}
                </div>
            </details>

            {# --- Other Stages (Validation, Publishing, Syndication) remain the same --- #}
            {# ... #}    
            {# --- Stage V: Local Validation --- #}
            <details class="workflow-stage" data-stage-key="validation">
                <summary>
                    <span class="traffic-light" data-status="{{ status.stages.validation.status | default('pending') }}"></span>
                    V. Local Validation
                </summary>
                <div class="stage-content">
                    <p>Run `npm start` and preview the post locally at `http://localhost:8080/{{ slug }}/`. Check everything thoroughly.</p>
                    <p>
                        <strong>Status:</strong> <code class="status-text">{{ status.stages.validation.status | default('pending') }}</code>
                         {% set current_status = status.stages.validation.status | default('pending') %}
                         {% if current_status != 'complete' %}<button class="status-update-button btn btn-sm btn-outline-success ms-2" data-slug="{{ slug }}" data-stage="validation" data-new-status="complete" title="Mark this stage as fully complete">Mark Complete</button>{% endif %}
                         {% if current_status != 'pending' %}<button class="status-update-button btn btn-sm btn-outline-secondary ms-2" data-slug="{{ slug }}" data-stage="validation" data-new-status="pending" title="Reset status to pending">Mark Pending</button>{% endif %}
                    </p>
                    <p><strong>Last Preview OK:</strong> {{ 'Yes' if status.stages.validation.last_preview_ok else 'No / Not Yet Run' }}</p>
                     <p class="mt-3">
                         <a href="http://localhost:8080/{{ slug }}/" target="_blank" class="btn btn-sm btn-primary">Preview Locally Now</a>
                         <span class="help-trigger" data-help-id="preview-help-{{ slug }}" title="Help for Preview Locally Link">?</span>
                         <div class="help-content" id="preview-help-{{ slug }}">{% include 'help/preview_local_help.njk' %}</div>
                     </p>
                </div>
            </details>
    
            {# --- Stage VI: Publishing (Clan.com) --- #}
            <details class="workflow-stage" data-stage-key="publishing_clancom">
                <summary>
                    <span class="traffic-light" data-status="{{ status.stages.publishing_clancom.status | default('pending') }}"></span>
                    VI. Publishing (Clan.com)
                </summary>
                <div class="stage-content">
                    <p>Uses the interface button to run `post_to_clan.py` script.</p>
                    <p>
                        <strong>Status:</strong> <code class="status-text">{{ status.stages.publishing_clancom.status | default('pending') }}</code>
                         {% if status.stages.publishing_clancom.status == 'complete' or status.stages.publishing_clancom.status == 'error' %}
                             <button class="status-update-button btn btn-sm btn-outline-secondary ms-2" data-slug="{{ slug }}" data-stage="publishing_clancom" data-new-status="pending" title="Reset status to allow re-publishing">Mark Pending</button>
                         {% endif %}
                    </p>
                    <p><strong>Clan.com Post ID:</strong> <code>{{ status.stages.publishing_clancom.post_id | default('N/A') }}</code></p>
                    <p><strong>Last Attempt:</strong> {{ status.stages.publishing_clancom.last_publish_attempt | default('N/A') }}</p>
                    <p><strong>Last Error:</strong> <code class="text-danger">{{ status.stages.publishing_clancom.last_error | default('None') }}</code></p> {# Use text-danger #}
                    <p class="mt-3">
                        {# Determine overall watermark status for ALL images #}
                        {% set all_watermarked = true %}
                        {% if not images_detailed %} {# If no images, consider watermarking done #}
                            {% set all_watermarked = true %}
                        {% else %}
                            {% for img_info in images_detailed %}
                                {% if img_info.watermarking_status != 'complete' %}
                                    {% set all_watermarked = false %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
    
                         {% set validation_status = status.stages.validation.status | default('pending') %}
                         {% set validation_done = validation_status == 'complete' %}
                         {% set ready_to_publish = all_watermarked and validation_done %}
    
                         <button class="publish-clan-button btn btn-success" data-slug="{{ slug }}" {# Use btn-success #}
                                 {{ 'disabled' if not ready_to_publish }}
                                 title="{{ 'Publish or Update post on Clan.com' if ready_to_publish else 'Complete Image Watermarking and Local Validation first' }}">
                             <i class="bi bi-cloud-upload"></i> Publish/Update Clan.com Now
                         </button>
                         <span class="help-trigger" data-help-id="publish-help-{{ slug }}" title="Help for Publish/Update Clan.com Button">?</span>
                         <div class="help-content" id="publish-help-{{ slug }}">{% include 'help/publish_clan_help.njk' %}</div>
                         {# Display dependency status #}
                         <small class="ms-2 d-block mt-1 text-muted">
                             (Requires: Validation <span class="traffic-light" data-status="{{ validation_status }}"></span> |
                             Watermarking <span class="traffic-light" data-status="{{ 'complete' if all_watermarked else 'pending' }}"></span>)
                        </small>
                    </p>
                    {% if status.stages.publishing_clancom.post_id %}
                        <p><a href="https://clan.com/blog/{{ slug }}.html" target="_blank">View Live Post (Check URL structure)</a></p> {# Adjust URL structure if needed #}
                    {% endif %}
                </div>
            </details>
    
            {# --- Stage VII: Social Media Syndication (Future) --- #}
            <details class="workflow-stage" data-stage-key="syndication">
                <summary>
                    <span class="traffic-light" data-status="{{ status.stages.syndication.status | default('pending') }}"></span>
                    VII. Social Media Syndication (Future)
                </summary>
                <div class="stage-content">
                    <p>Prepare platform-specific content and run the syndication script.</p>
                    <p>
                        <strong>Overall Status:</strong> <code class="status-text">{{ status.stages.syndication.status | default('pending') }}</code>
                        {% set current_status = status.stages.syndication.status | default('pending') %}
                        {% if current_status != 'complete' %}<button class="status-update-button btn btn-sm btn-outline-success ms-2" data-slug="{{ slug }}" data-stage="syndication" data-new-status="complete" title="Mark this stage as fully complete">Mark Complete</button>{% endif %}
                        {% if current_status != 'pending' %}<button class="status-update-button btn btn-sm btn-outline-secondary ms-2" data-slug="{{ slug }}" data-stage="syndication" data-new-status="pending" title="Reset status to pending">Mark Pending</button>{% endif %}
                    </p>
                    <p><strong>Instagram:</strong> <span class="traffic-light" data-status="{{ status.stages.syndication.instagram.overall_status | default('pending') if status.stages.syndication.instagram is defined else 'pending' }}"></span> <code class="status-text">{{ status.stages.syndication.instagram.overall_status | default('pending') if status.stages.syndication.instagram is defined else 'pending' }}</code></p>
                    <p><strong>Facebook:</strong> <span class="traffic-light" data-status="{{ status.stages.syndication.facebook.overall_status | default('pending') if status.stages.syndication.facebook is defined else 'pending' }}"></span> <code class="status-text">{{ status.stages.syndication.facebook.overall_status | default('pending') if status.stages.syndication.facebook is defined else 'pending' }}</code></p>
                    <p class="mt-3">
                        <button class="syndicate-button btn btn-sm btn-secondary" data-slug="{{ slug }}" data-platform="instagram" disabled title="Instagram syndication not yet implemented">Syndicate to Instagram</button>
                        <button class="syndicate-button btn btn-sm btn-secondary" data-slug="{{ slug }}" data-platform="facebook" disabled title="Facebook syndication not yet implemented">Syndicate to Facebook</button>
                        <span class="help-trigger" data-help-id="syndicate-help-{{ slug }}" title="Help for Syndication">?</span>
                        <div class="help-content" id="syndicate-help-{{ slug }}">{% include 'help/syndicate_help.njk' %}</div>
                    </p>
                </div>
            </details>
    
        </section>

        <section id="log-section" style="margin-top: 30px;">
            <h2>Action Log / Output</h2>
            <pre id="log-output" class="bg-light border rounded p-2">(Action output will appear here)</pre> {# Use bg-light etc #}
        </section>

    </div> {# End container #}

    <script>
        const logOutput = document.getElementById('log-output');
        
        // --- Helper Function for Logging to Page ---
        function logMessage(message, isError = false) {
            // ... (keep this function as it is) ...
        }
        
        // --- Main Click Event Listener ---
        document.body.addEventListener('click', function(event) {
            const targetElement = event.target;
            console.log(`[DEBUG] Body clicked. Target element:`, targetElement);
            console.log(`[DEBUG] Target classes:`, targetElement.classList);
    
            // --- Use closest() to find the nearest relevant ancestor button/trigger ---
            const publishButton = targetElement.closest('.publish-clan-button');
            const statusUpdateButton = targetElement.closest('.status-update-button');
            const helpTrigger = targetElement.closest('.help-trigger');
    
            // --- Handle based on which button/trigger was found ---
            if (publishButton) {
                console.log("[DEBUG] EXECUTING Publish block.");
                const slug = publishButton.dataset.slug;
                if (!slug) { logMessage("Error: No slug found on publish button.", true); return; }
    
                logMessage(`Starting Publish/Update job for '${slug}'...`);
                publishButton.disabled = true;
                publishButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Publishing...';
    
                fetch(`/api/publish_clan/${slug}`, { method: 'POST' })
                .then(response => { if (!response.ok) { throw new Error(`HTTP error ${response.status}`); } return response.json(); })
                .then(data => {
                    logMessage(`Publish job finished for '${slug}'. Success: ${data.success}`, !data.success);
                    logMessage("--- Script Output ---");
                    const outputLines = data.output.split('\n');
                     outputLines.forEach(line => {
                          // Simple check for common error indicators
                          const isErrorLine = /ERROR|Traceback|Failed|Not Found|Critical/i.test(line);
                          logMessage(line.trim(), isErrorLine);
                     });
                    logMessage("--- End Script Output ---");
    
                     if (!data.success) {
                          alert(`Publishing script failed or had errors for ${slug}. Check log.`);
                          publishButton.innerHTML = '<i class="bi bi-exclamation-triangle-fill"></i> Error';
                          publishButton.classList.remove('btn-success'); publishButton.classList.add('btn-danger');
                          // Keep button disabled on error? Or re-enable after timeout? Re-enable for now.
                          setTimeout(() => {
                               publishButton.disabled = false;
                               publishButton.innerHTML = '<i class="bi bi-cloud-upload"></i> Publish/Update Clan.com Now';
                               publishButton.classList.remove('btn-danger'); publishButton.classList.add('btn-success');
                           }, 3000);
                     } else {
                          publishButton.innerHTML = '<i class="bi bi-check-circle-fill"></i> Success!';
                          // Re-enable button after success message?
                           setTimeout(() => {
                               publishButton.disabled = false;
                               publishButton.innerHTML = '<i class="bi bi-cloud-upload"></i> Publish/Update Clan.com Now';
                               logMessage(`Publishing complete for ${slug}. Reload page or check index for updated status.`, false);
                               alert(`Publishing complete for ${slug}. Reload page or check index for updated status.`);
                           }, 2000);
                     }
    
                }).catch(error => {
                    logMessage(`Network Error during publish fetch for '${slug}': ${error.message}`, true);
                     publishButton.innerHTML = '<i class="bi bi-exclamation-triangle-fill"></i> Network Error';
                     publishButton.classList.remove('btn-success'); publishButton.classList.add('btn-danger');
                      setTimeout(() => {
                           publishButton.disabled = false;
                           publishButton.innerHTML = '<i class="bi bi-cloud-upload"></i> Publish/Update Clan.com Now';
                           publishButton.classList.remove('btn-danger'); publishButton.classList.add('btn-success');
                      }, 3000);
                });
            }
            else if (statusUpdateButton) {
                console.log("[DEBUG] EXECUTING Status Update block.");
                // ... (keep existing status update logic) ...
            }
            else if (helpTrigger) {
                 console.log("[DEBUG] EXECUTING Help Trigger block.");
                 // ... (keep existing help logic) ...
            }
            // --- Handle clicking outside help ---
            else if (!targetElement.closest('.help-trigger') && !targetElement.closest('.help-content.active')) {
                 document.querySelectorAll('.help-content.active').forEach(activeHelp => {
                      activeHelp.classList.remove('active');
                 });
            }
        });
    
        // Initial log message
        console.log("[DEBUG] Admin post detail JS loaded. Event listeners active.");
        logMessage("Admin post detail interface loaded."); // Log to page

        // Theme toggle functionality
        const themeToggle = document.getElementById('themeToggle');
        const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
        
        // Check for saved theme preference or use system preference
        const currentTheme = localStorage.getItem('theme') || 
                           (prefersDarkScheme.matches ? 'dark' : 'light');
        
        if (currentTheme === 'dark') {
            document.body.setAttribute('data-theme', 'dark');
            themeToggle.textContent = 'Toggle Light Mode';
        }

        themeToggle.addEventListener('click', () => {
            const currentTheme = document.body.getAttribute('data-theme');
            if (currentTheme === 'dark') {
                document.body.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
                themeToggle.textContent = 'Toggle Dark Mode';
            } else {
                document.body.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
                themeToggle.textContent = 'Toggle Light Mode';
            }
        });

        // Add event listener for save button
        document.getElementById('save-metadata').addEventListener('click', function() {
            const slug = '{{ slug }}';
            const fields = ['concept', 'title', 'subtitle', 'slug'];
            const data = {};
            
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    data[field] = element.value;
                }
            });

            const saveButton = this;
            const saveStatus = document.getElementById('save-status');
            
            saveButton.disabled = true;
            saveButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
            saveStatus.textContent = '';

            fetch(`/api/update_metadata/${slug}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    saveButton.innerHTML = '<i class="bi bi-check-circle-fill"></i> Saved';
                    saveStatus.textContent = 'Changes saved successfully';
                    saveStatus.className = 'ms-2 text-success';
                    
                    // Update the conceptualisation status if all fields are filled
                    const hasTitle = document.getElementById('title').value.trim() !== '';
                    const hasSubtitle = document.getElementById('subtitle').value.trim() !== '';
                    const hasSlug = document.getElementById('slug').value.trim() !== '';
                    const hasConcept = document.getElementById('concept').value.trim() !== '';
                    
                    if (hasTitle && hasSubtitle && hasSlug && hasConcept) {
                        const statusElement = document.querySelector('[data-stage-key="conceptualisation"] .traffic-light');
                        if (statusElement) {
                            statusElement.setAttribute('data-status', 'complete');
                        }
                    }
                } else {
                    throw new Error(data.error || 'Failed to save changes');
                }
            })
            .catch(error => {
                saveButton.innerHTML = '<i class="bi bi-exclamation-triangle-fill"></i> Error';
                saveStatus.textContent = `Error: ${error.message}`;
                saveStatus.className = 'ms-2 text-danger';
            })
            .finally(() => {
                setTimeout(() => {
                    saveButton.disabled = false;
                    saveButton.innerHTML = 'Save Changes';
                    saveStatus.textContent = '';
                }, 3000);
            });
        });

        // Add input event listeners to update save button state
        const fields = ['concept', 'title', 'subtitle', 'slug'];
        fields.forEach(field => {
            const element = document.getElementById(field);
            if (element) {
                element.addEventListener('input', function() {
                    const saveButton = document.getElementById('save-metadata');
                    if (saveButton) {
                        saveButton.disabled = false;
                    }
                });
            }
        });

        // Content Authoring & Structuring functionality
        document.getElementById('add-section').addEventListener('click', function() {
            const sectionsContainer = document.getElementById('sections-container');
            const sectionCount = sectionsContainer.children.length;
            const newSection = document.createElement('div');
            newSection.className = 'section-item mb-4 p-3 border rounded';
            newSection.setAttribute('data-section-index', sectionCount);
            newSection.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">Section ${sectionCount + 1}</h4>
                    <button type="button" class="btn btn-sm btn-outline-danger delete-section" data-section-index="${sectionCount}">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </div>
                <div class="mb-3">
                    <label class="form-label">Heading</label>
                    <input type="text" class="form-control section-heading" data-field="heading">
                </div>
                <div class="mb-3">
                    <label class="form-label">Content</label>
                    <textarea class="form-control section-content" rows="5" data-field="text"></textarea>
                    <div class="form-text">Use HTML tags for formatting (p, b, i, ul, li)</div>
                </div>
            `;
            sectionsContainer.appendChild(newSection);
        });

        // Handle section deletion
        document.addEventListener('click', function(e) {
            if (e.target.closest('.delete-section')) {
                const section = e.target.closest('.section-item');
                section.remove();
                // Update section numbers
                const sections = document.querySelectorAll('.section-item');
                sections.forEach((section, index) => {
                    section.setAttribute('data-section-index', index);
                    section.querySelector('h4').textContent = `Section ${index + 1}`;
                    section.querySelector('.delete-section').setAttribute('data-section-index', index);
                });
            }
        });

        // Save content
        document.getElementById('save-content').addEventListener('click', function() {
            const slug = '{{ slug }}';
            const data = {
                summary: document.getElementById('summary').value,
                sections: [],
                conclusion: {
                    heading: document.getElementById('conclusion-heading').value,
                    text: document.getElementById('conclusion-text').value
                }
            };

            // Collect section data
            document.querySelectorAll('.section-item').forEach(section => {
                data.sections.push({
                    heading: section.querySelector('.section-heading').value,
                    text: section.querySelector('.section-content').value
                });
            });

            const saveButton = this;
            const saveStatus = document.getElementById('save-content-status');
            
            saveButton.disabled = true;
            saveButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
            saveStatus.textContent = '';

            fetch(`/api/update_content/${slug}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    saveButton.innerHTML = '<i class="bi bi-check-circle-fill"></i> Saved';
                    saveStatus.textContent = 'Content saved successfully';
                    saveStatus.className = 'ms-2 text-success';
                } else {
                    throw new Error(data.error || 'Failed to save content');
                }
            })
            .catch(error => {
                saveButton.innerHTML = '<i class="bi bi-exclamation-triangle-fill"></i> Error';
                saveStatus.textContent = `Error: ${error.message}`;
                saveStatus.className = 'ms-2 text-danger';
            })
            .finally(() => {
                setTimeout(() => {
                    saveButton.disabled = false;
                    saveButton.innerHTML = 'Save Content';
                    saveStatus.textContent = '';
                }, 3000);
            });
        });
    </script>
</body>
</html>