<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {# Title uses metadata passed from Flask #}
    <title>Manage: {{ metadata.title | default('Unknown Post') }} - Blog Workflow</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 900px; margin: auto; }
        h1, h2, h3 { border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 15px; }
        a { color: #007bff; text-decoration: none; }
        a:hover { text-decoration: underline; }
        .back-link { margin-bottom: 20px; display: block; }
        code { background-color: #eee; padding: 0.1em 0.3em; border-radius: 2px; font-size: 0.95em; }
        button { padding: 5px 10px; margin-left: 10px; cursor: pointer; font-size: 0.9em;}
        button:disabled { cursor: not-allowed; opacity: 0.6; }
        small { font-size: 0.85em; }

        /* Traffic Light Styles */
        .traffic-light { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; vertical-align: middle; border: 1px solid rgba(0,0,0,0.1); }
        .traffic-light[data-status="pending"] { background-color: #ccc; /* Grey */ }
        .traffic-light[data-status="partial"] { background-color: #f0ad4e; /* Orange */ }
        .traffic-light[data-status="complete"] { background-color: #5cb85c; /* Green */ }
        .traffic-light[data-status="error"] { background-color: #d9534f; /* Red */ }

        /* Collapsible Section Styles */
        details.workflow-stage { border: 1px solid #eee; margin-bottom: 10px; border-radius: 4px; }
        details.workflow-stage summary { padding: 10px; background-color: #f9f9f9; cursor: pointer; font-weight: bold; outline: none; display: flex; align-items: center; }
        details.workflow-stage[open] summary { border-bottom: 1px solid #eee; }
        div.stage-content { padding: 15px; border-top: 1px solid #eee; }
        div.stage-content p { margin-bottom: 0.75em; line-height: 1.5; }
        div.stage-content p:last-child { margin-bottom: 0; }
        div.stage-content .status-text { font-weight: bold; }

        /* Help System Styles */
        .help-trigger { display: inline-block; width: 16px; height: 16px; line-height: 16px; margin-left: 6px; font-size: 11px; font-weight: bold; text-align: center; color: #fff; background-color: #77aaff; border-radius: 50%; cursor: pointer; user-select: none; vertical-align: middle; transition: background-color 0.2s ease; }
        .help-trigger:hover { background-color: #4477cc; }
        .help-content { display: none; position: absolute; background-color: #ffffe0; border: 1px solid #ccc; border-radius: 4px; padding: 10px 15px; box-shadow: 2px 2px 5px rgba(0,0,0,0.15); z-index: 10; left: 25px; top: 0; width: 300px; font-size: 0.9em; line-height: 1.5; letter-spacing: normal; text-align: left; }
        .help-content p, .help-content ul, .help-content ol { margin-bottom: 0.8em; letter-spacing: normal; }
        .help-content ul, .help-content ol { padding-left: 1.5em; }
        .help-content code { background-color: #eee; padding: 0.1em 0.3em; border-radius: 2px; font-size: 0.95em; }
        .help-content.active { display: block; }
        h2 > .help-trigger { vertical-align: baseline; }
        h2 + .help-content { top: 25px; left: 0; }

        /* Log Output Styles */
        #log-output { margin-top: 20px; padding: 10px; border: 1px solid #eee; background-color: #f8f8f8; min-height: 100px; white-space: pre-wrap; font-family: monospace; font-size: 0.9em; max-height: 300px; overflow-y: auto; }
        #log-output div { margin-bottom: 2px; line-height: 1.3; }
    </style>
</head>
<body>
    <p class="back-link"><a href="{{ url_for('index') }}">‚Üê Back to Post List</a></p>

    <h1>Manage: {{ metadata.title | default('Post Details') }}</h1>
    <p><strong>Slug:</strong> <code>{{ slug }}</code></p>

    <section id="workflow-stages">
        <h2>Workflow Stages <span class="help-trigger" data-help-id="manage-posts-main-help" title="Help for Manage Posts Section">?</span></h2>
         <div class="help-content" id="manage-posts-main-help">{% include 'help/manage_posts_help.njk' %}</div>

        {# --- Stage I: Conceptualisation --- #}
        <details class="workflow-stage" data-stage-key="conceptualisation">
            <summary>
                <span class="traffic-light" data-status="{{ status.stages.conceptualisation.status | default('pending') }}"></span>
                I. Conceptualisation
            </summary>
            <div class="stage-content">
                <p>Define the core idea, Title, Subtitle, and URL Slug.</p>
                <p>
                    <strong>Status:</strong> <code class="status-text">{{ status.stages.conceptualisation.status | default('pending') }}</code>
                    {% set current_status = status.stages.conceptualisation.status | default('pending') %}
                    {% if current_status != 'complete' %}<button class="status-update-button" data-slug="{{ slug }}" data-stage="conceptualisation" data-new-status="complete" title="Mark this stage as fully complete">Mark Complete</button>{% endif %}
                    {% if current_status != 'pending' %}<button class="status-update-button" data-slug="{{ slug }}" data-stage="conceptualisation" data-new-status="pending" title="Reset status to pending">Mark Pending</button>{% endif %}
                </p>
                <p>Notes: {{ status.stages.conceptualisation.notes | default('N/A') }}</p>
            </div>
        </details>

        {# --- Stage II: Authoring --- #}
        <details class="workflow-stage" data-stage-key="authoring">
            <summary>
                <span class="traffic-light" data-status="{{ status.stages.authoring.status | default('pending') }}"></span>
                II. Content Authoring & Structuring
            </summary>
            <div class="stage-content">
                <p>Generate/write, review, edit, structure, and format the text content (Summary, Sections, Conclusion) using HTML.</p>
                <p>
                    <strong>Overall Status:</strong> <code class="status-text">{{ status.stages.authoring.status | default('pending') }}</code>
                    {% set current_status = status.stages.authoring.status | default('pending') %}
                    {% if current_status != 'complete' %}<button class="status-update-button" data-slug="{{ slug }}" data-stage="authoring" data-new-status="complete" title="Mark this stage as fully complete">Mark Complete</button>{% endif %}
                    {% if current_status != 'pending' %}<button class="status-update-button" data-slug="{{ slug }}" data-stage="authoring" data-new-status="pending" title="Reset status to pending">Mark Pending</button>{% endif %}
                </p>
                <p><strong>HTML Formatting Status:</strong> <span class="traffic-light" data-status="{{ status.stages.authoring.text_format_status | default('pending') }}"></span> <code class="status-text">{{ status.stages.authoring.text_format_status | default('pending') }}</code></p>
            </div>
        </details>

        {# --- Stage III: Metadata & File Setup --- #}
        <details class="workflow-stage" data-stage-key="metadata">
            <summary>
                <span class="traffic-light" data-status="{{ status.stages.metadata.status | default('pending') }}"></span>
                III. Metadata & File Setup
            </summary>
            <div class="stage-content">
                <p>Create the `.md` file and populate YAML front matter (Title, Subtitle, Description, Date, Author Key, Tags, Content Placeholders).</p>
                <p>
                    <strong>Overall Status:</strong> <code class="status-text">{{ status.stages.metadata.status | default('pending') }}</code>
                     {% set current_status = status.stages.metadata.status | default('pending') %}
                     {% if current_status != 'complete' %}<button class="status-update-button" data-slug="{{ slug }}" data-stage="metadata" data-new-status="complete" title="Mark this stage as fully complete">Mark Complete</button>{% endif %}
                     {% if current_status != 'pending' %}<button class="status-update-button" data-slug="{{ slug }}" data-stage="metadata" data-new-status="pending" title="Reset status to pending">Mark Pending</button>{% endif %}
                </p>
                <p><strong>Front Matter Populated:</strong> <span class="traffic-light" data-status="{{ status.stages.metadata.front_matter_status | default('pending') }}"></span> <code class="status-text">{{ status.stages.metadata.front_matter_status | default('pending') }}</code></p>
                <p><strong>Tags Defined:</strong> <span class="traffic-light" data-status="{{ status.stages.metadata.tags_status | default('pending') }}"></span> <code class="status-text">{{ status.stages.metadata.tags_status | default('pending') }}</code></p>
                <p><strong>Author Assigned:</strong> <span class="traffic-light" data-status="{{ status.stages.metadata.author_status | default('pending') }}"></span> <code class="status-text">{{ status.stages.metadata.author_status | default('pending') }}</code></p>
                <hr>
                 <p><i>Title: {{ metadata.title }}</i></p>
                 <p><i>Author Key: {{ metadata.author }}</i></p>
                 <p><i>Tags: {{ metadata.tags | join(', ') }}</i></p>
            </div>
        </details>

        {# --- Stage IV: Image Workflow --- #}
        <details class="workflow-stage" data-stage-key="images">
            <summary>
                <span class="traffic-light" data-status="{{ status.stages.images.status | default('pending') }}"></span>
                 IV. Image Workflow
            </summary>
            <div class="stage-content">
                <p>Define prompts, generate/select, rename/place, watermark (optional), integrate paths/alt/captions.</p>
                 <p>
                     <strong>Overall Status:</strong> <code class="status-text">{{ status.stages.images.status | default('pending') }}</code>
                     {% set current_status = status.stages.images.status | default('pending') %}
                     {% if current_status != 'complete' %}<button class="status-update-button" data-slug="{{ slug }}" data-stage="images" data-new-status="complete" title="Mark this stage as fully complete">Mark Complete</button>{% endif %}
                     {% if current_status != 'pending' %}<button class="status-update-button" data-slug="{{ slug }}" data-stage="images" data-new-status="pending" title="Reset status to pending">Mark Pending</button>{% endif %}
                 </p>
                 <hr>
                 <p><strong>Prompts Defined:</strong> <span class="traffic-light" data-status="{{ status.stages.images.prompts_defined_status | default('pending') }}"></span> <code class="status-text">{{ status.stages.images.prompts_defined_status | default('pending') }}</code></p>
                 <p><strong>Image Generation/Selection:</strong> <span class="traffic-light" data-status="{{ status.stages.images.generation_status | default('pending') }}"></span> <code class="status-text">{{ status.stages.images.generation_status | default('pending') }}</code></p>
                 <p><strong>Assets Prepared (Renamed/Placed):</strong> <span class="traffic-light" data-status="{{ status.stages.images.assets_prepared_status | default('pending') }}"></span> <code class="status-text">{{ status.stages.images.assets_prepared_status | default('pending') }}</code></p>
                 <p><strong>Metadata Integrated (src/alt/caption):</strong> <span class="traffic-light" data-status="{{ status.stages.images.metadata_integrated_status | default('pending') }}"></span> <code class="status-text">{{ status.stages.images.metadata_integrated_status | default('pending') }}</code></p>
                 <p><strong>Watermarking Status:</strong> <span class="traffic-light" data-status="{{ status.stages.images.watermarking_status | default('pending') }}"></span> <code class="status-text">{{ status.stages.images.watermarking_status | default('pending') }}</code></p>
                 <p style="margin-top: 1em;">
                     {% set assets_ready = status.stages.images.assets_prepared_status == 'complete' %}
                     <button class="watermark-button" data-slug="{{ slug }}"
                             {{ 'disabled' if not assets_ready }}
                             title="{{ 'Run the watermarking script' if assets_ready else 'Assets must be prepared first' }}">
                         Run Watermark Script
                     </button>
                     <span class="help-trigger" data-help-id="watermark-help-{{ slug }}" title="Help for Watermarking">?</span>
                     <div class="help-content" id="watermark-help-{{ slug }}">{% include 'help/watermark_help.njk' %}</div> {# Placeholder - create this help file #}
                 </p>
            </div>
        </details>

        {# --- Stage V: Local Validation --- #}
        <details class="workflow-stage" data-stage-key="validation">
            <summary>
                <span class="traffic-light" data-status="{{ status.stages.validation.status | default('pending') }}"></span>
                V. Local Validation
            </summary>
            <div class="stage-content">
                <p>Run `npm start` and preview the post locally at `http://localhost:8080/{{ slug }}/`. Check everything thoroughly.</p>
                <p>
                    <strong>Status:</strong> <code class="status-text">{{ status.stages.validation.status | default('pending') }}</code>
                     {% set current_status = status.stages.validation.status | default('pending') %}
                     {% if current_status != 'complete' %}<button class="status-update-button" data-slug="{{ slug }}" data-stage="validation" data-new-status="complete" title="Mark this stage as fully complete">Mark Complete</button>{% endif %}
                     {% if current_status != 'pending' %}<button class="status-update-button" data-slug="{{ slug }}" data-stage="validation" data-new-status="pending" title="Reset status to pending">Mark Pending</button>{% endif %}
                </p>
                <p><strong>Last Preview OK:</strong> {{ 'Yes' if status.stages.validation.last_preview_ok else 'No / Not Yet Run' }}</p>
                 <p style="margin-top: 1em;">
                     <a href="http://localhost:8080/{{ slug }}/" target="_blank">Preview Locally Now</a>
                     <span class="help-trigger" data-help-id="preview-help-{{ slug }}" title="Help for Preview Locally Link">?</span>
                     <div class="help-content" id="preview-help-{{ slug }}">{% include 'help/preview_local_help.njk' %}</div>
                 </p>
                 {# Add button to mark preview OK later #}
            </div>
        </details>

        {# --- Stage VI: Publishing (Clan.com) --- #}
        <details class="workflow-stage" data-stage-key="publishing_clancom">
            <summary>
                <span class="traffic-light" data-status="{{ status.stages.publishing_clancom.status | default('pending') }}"></span>
                VI. Publishing (Clan.com)
            </summary>
            <div class="stage-content">
                <p>Uses the interface button to run `post_to_clan.py` script.</p>
                <p>
                    <strong>Status:</strong> <code class="status-text">{{ status.stages.publishing_clancom.status | default('pending') }}</code>
                     {% if status.stages.publishing_clancom.status == 'complete' or status.stages.publishing_clancom.status == 'error' %}
                         <button class="status-update-button" data-slug="{{ slug }}" data-stage="publishing_clancom" data-new-status="pending" title="Reset status to allow re-publishing">Mark Pending</button>
                     {% endif %}
                </p>
                <p><strong>Clan.com Post ID:</strong> <code>{{ status.stages.publishing_clancom.post_id | default('N/A') }}</code></p>
                <p><strong>Last Attempt:</strong> {{ status.stages.publishing_clancom.last_publish_attempt | default('N/A') }}</p>
                <p><strong>Last Error:</strong> <code style="color: red;">{{ status.stages.publishing_clancom.last_error | default('None') }}</code></p>
                <p style="margin-top: 1em;">
                     {# --- UPDATED: Conditional Disable for Publish Button --- #}
                     {% set watermark_done = status.stages.images.watermarking_status == 'complete' %}
                     {# You might add other checks, e.g. validation complete: and status.stages.validation.status == 'complete' #}
                     <button class="publish-clan-button" data-slug="{{ slug }}"
                             {{ 'disabled' if not watermark_done }}
                             title="{{ 'Publish or Update post on Clan.com' if watermark_done else 'Watermarking must be complete first' }}">
                         Publish/Update Clan.com Now
                     </button>
                     <span class="help-trigger" data-help-id="publish-help-{{ slug }}" title="Help for Publish/Update Clan.com Button">?</span>
                     <div class="help-content" id="publish-help-{{ slug }}">{% include 'help/publish_clan_help.njk' %}</div>
                </p>
                {% if status.stages.publishing_clancom.post_id %}
                    <p><a href="https://clan.com/blog/{{ slug }}.html" target="_blank">View Live Post (Check URL structure)</a></p> {# Adjust URL structure if needed #}
                {% endif %}
            </div>
        </details>

        {# --- Stage VII: Social Media Syndication (Future) --- #}
        <details class="workflow-stage" data-stage-key="syndication">
            <summary>
                <span class="traffic-light" data-status="{{ status.stages.syndication.status | default('pending') }}"></span>
                VII. Social Media Syndication (Future)
            </summary>
            <div class="stage-content">
                <p>Prepare platform-specific content and run the syndication script.</p>
                <p>
                    <strong>Overall Status:</strong> <code class="status-text">{{ status.stages.syndication.status | default('pending') }}</code>
                    {% set current_status = status.stages.syndication.status | default('pending') %}
                    {% if current_status != 'complete' %}<button class="status-update-button" data-slug="{{ slug }}" data-stage="syndication" data-new-status="complete" title="Mark this stage as fully complete">Mark Complete</button>{% endif %}
                    {% if current_status != 'pending' %}<button class="status-update-button" data-slug="{{ slug }}" data-stage="syndication" data-new-status="pending" title="Reset status to pending">Mark Pending</button>{% endif %}
                </p>
                <p><strong>Instagram:</strong> <span class="traffic-light" data-status="{{ status.stages.syndication.instagram.overall_status | default('pending') }}"></span> <code class="status-text">{{ status.stages.syndication.instagram.overall_status | default('pending') }}</code></p>
                <p><strong>Facebook:</strong> <span class="traffic-light" data-status="{{ status.stages.syndication.facebook.overall_status | default('pending') }}"></span> <code class="status-text">{{ status.stages.syndication.facebook.overall_status | default('pending') }}</code></p>
                <p style="margin-top: 1em;">
                    <button class="syndicate-button" data-slug="{{ slug }}" data-platform="instagram" disabled title="Instagram syndication not yet implemented">Syndicate to Instagram</button>
                    <button class="syndicate-button" data-slug="{{ slug }}" data-platform="facebook" disabled title="Facebook syndication not yet implemented">Syndicate to Facebook</button>
                    <span class="help-trigger" data-help-id="syndicate-help-{{ slug }}" title="Help for Syndication">?</span>
                    <div class="help-content" id="syndicate-help-{{ slug }}">{% include 'help/syndicate_help.njk' %}</div> {# Placeholder - create this help file #}
                </p>
            </div>
        </details>

    </section>

    <section id="log-section" style="margin-top: 30px;">
        <h2>Action Log / Output</h2>
        <pre id="log-output" style="border: 1px solid #eee; background-color: #f8f8f8; min-height: 100px; padding: 10px; white-space: pre-wrap; font-family: monospace; font-size: 0.9em; max-height: 300px; overflow-y: auto;">(Action output will appear here)</pre>
    </section>

    <!-- JavaScript for interactions -->
    <script>
        // ... (JavaScript remains the same as previous version) ...
        const logOutput = document.getElementById('log-output');
        document.body.addEventListener('click', function(event) {
            if (event.target.matches('.publish-clan-button')) {
                const button = event.target; const slug = button.dataset.slug; if (!slug) { logMessage("Error: No slug found.", true); return; }
                logMessage(`Starting Publish/Update job for '${slug}'...`); button.disabled = true; button.textContent = 'Processing...';
                fetch(`/api/publish_clan/${slug}`, { method: 'POST' })
                .then(response => { if (!response.ok) { throw new Error(`HTTP error ${response.status}`); } return response.json(); })
                .then(data => {
                    logMessage(`Job finished for '${slug}'. Success: ${data.success}`); logMessage("--- Script Output ---");
                    const outputLines = data.output.split('\n'); outputLines.forEach(line => { const isErrorLine = /ERROR|Traceback|Failed/i.test(line); logMessage(line.trim(), isErrorLine); }); logMessage("--- End Script Output ---");
                    if (!data.success) { alert(`Script failed for ${slug}. Check log.`); } else {
                        button.textContent = 'Success!'; setTimeout(() => { button.disabled = false; button.textContent = 'Publish/Update Clan.com Now'; logMessage(`Action complete for ${slug}. Refresh page to see updated status.`); }, 2000); return;
                    }
                }).catch(error => { logMessage(`Error during fetch for '${slug}': ${error.message}`, true); console.error('Fetch Error:', error); })
                .finally(() => { if (button.textContent !== 'Success!') { button.disabled = false; button.textContent = 'Publish/Update Clan.com Now'; } });
            }
            else if (event.target.matches('.status-update-button')) {
                const button = event.target; const slug = button.dataset.slug; const stageKey = button.dataset.stage; const newStatus = button.dataset.newStatus;
                if (!slug || !stageKey || !newStatus) { logMessage("Error: Missing data on status button.", true); return; }
                logMessage(`Updating status for '${slug}/${stageKey}' to '${newStatus}'...`); button.disabled = true;
                fetch(`/api/update_status/${slug}/${stageKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: newStatus }) })
                .then(response => { if (!response.ok) { throw new Error(`HTTP error ${response.status}`); } return response.json(); })
                .then(data => { if (data.success) { logMessage(`Status updated for '${data.slug}/${data.stage}' to '${data.new_status}'. Reloading...`); window.location.reload(); } else { logMessage(`Error: ${data.message}`, true); alert(`Error: ${data.message}`); button.disabled = false; } })
                .catch(error => { logMessage(`Error during status update fetch for '${slug}/${stageKey}': ${error.message}`, true); console.error('Fetch Error:', error); button.disabled = false; });
            }
             else if (event.target.matches('.help-trigger')) { /* ... Help logic ... */ }
             else if (!event.target.closest('.help-content') && !event.target.matches('.help-trigger')) { /* ... Hide help logic ... */ }
        });
        console.log("Admin interface loaded.");
    </script>

</body>
</html>