<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {# Title uses metadata passed from Flask #}
    <title>Manage: {{ metadata.title | default('Unknown Post') }} - Blog Workflow</title>
    {# Link to a potential shared CSS or use inline styles for now #}
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 900px; margin: auto; }
        h1, h2, h3 { border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 15px; }
        a { color: #007bff; text-decoration: none; }
        a:hover { text-decoration: underline; }
        .back-link { margin-bottom: 20px; display: block; }
        
        /* Add styles for details/summary/traffic light later */
        /* Add these styles inside the <style> tag */
            .traffic-light {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
            border: 1px solid rgba(0,0,0,0.1); /* Subtle border */
        }
        .traffic-light[data-status="pending"] { background-color: #ccc; /* Grey */ }
        .traffic-light[data-status="partial"] { background-color: #f0ad4e; /* Orange */ }
        .traffic-light[data-status="complete"] { background-color: #5cb85c; /* Green */ }
        .traffic-light[data-status="error"] { background-color: #d9534f; /* Red */ }

        details.workflow-stage {
            border: 1px solid #eee;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        details.workflow-stage summary {
            padding: 10px;
            background-color: #f9f9f9;
            cursor: pointer;
            font-weight: bold;
            outline: none; /* Remove default focus outline if desired */
        }
         details.workflow-stage[open] summary {
             border-bottom: 1px solid #eee;
         }
        div.stage-content {
            padding: 15px;
            border-top: 1px solid #eee; /* Separator when open */
        }
        div.stage-content p { margin-bottom: 0.5em;}
        div.stage-content code { background-color: #eee; padding: 0.1em 0.3em; border-radius: 2px; }
        div.stage-content .status-text { font-weight: bold; }
    </style>
</head>
<body>
    <p class="back-link"><a href="{{ url_for('index') }}">‚Üê Back to Post List</a></p>

    {# Display Title from metadata #}
    <h1>Manage: {{ metadata.title | default('Post Details') }}</h1>
    <p><strong>Slug:</strong> <code>{{ slug }}</code></p>

    <section id="workflow-stages">
        <h2>Workflow Stages</h2>

        {# --- Stage I: Conceptualisation --- #}
        <details class="workflow-stage" data-stage-key="conceptualisation">
            <summary>
                <span class="traffic-light" data-status="{{ status.stages.conceptualisation.status | default('pending') }}"></span>
                I. Conceptualisation
            </summary>
            <div class="stage-content">
                <p>Define the core idea, Title, Subtitle, and URL Slug.</p>
                <p>
                    <strong>Status:</strong> <code class="status-text">{{ status.stages.conceptualisation.status | default('pending') }}</code>
                    {% set current_status = status.stages.conceptualisation.status | default('pending') %}
                    {% if current_status != 'complete' %}<button class="status-update-button" data-slug="{{ slug }}" data-stage="conceptualisation" data-new-status="complete" title="Mark this stage as fully complete">Mark Complete</button>{% endif %}
                    {% if current_status != 'pending' %}<button class="status-update-button" data-slug="{{ slug }}" data-stage="conceptualisation" data-new-status="pending" title="Reset status to pending">Mark Pending</button>{% endif %}
                </p>
                <p>Notes: {{ status.stages.conceptualisation.notes | default('N/A') }}</p>
            </div>
        </details>

        {# --- Stage II: Authoring --- #}
        <details class="workflow-stage" data-stage-key="authoring">
            <summary>
                <span class="traffic-light" data-status="{{ status.stages.authoring.status | default('pending') }}"></span>
                II. Content Authoring & Structuring
            </summary>
            <div class="stage-content">
                <p>Generate/write, review, edit, structure, and format the text content (Summary, Sections, Conclusion) using HTML.</p>
                <p>
                    <strong>Overall Status:</strong> <code class="status-text">{{ status.stages.authoring.status | default('pending') }}</code>
                    {% set current_status = status.stages.authoring.status | default('pending') %}
                    {% if current_status != 'complete' %}<button class="status-update-button" data-slug="{{ slug }}" data-stage="authoring" data-new-status="complete" title="Mark this stage as fully complete">Mark Complete</button>{% endif %}
                    {% if current_status != 'pending' %}<button class="status-update-button" data-slug="{{ slug }}" data-stage="authoring" data-new-status="pending" title="Reset status to pending">Mark Pending</button>{% endif %}
                </p>
                <p><strong>HTML Formatting Status:</strong> <span class="traffic-light" data-status="{{ status.stages.authoring.text_format_status | default('pending') }}"></span> <code class="status-text">{{ status.stages.authoring.text_format_status | default('pending') }}</code></p> {# Sub-status - no button for now #}
            </div>
        </details>

        {# --- Stage III: Metadata & File Setup --- #}
        <details class="workflow-stage" data-stage-key="metadata">
            <summary>
                <span class="traffic-light" data-status="{{ status.stages.metadata.status | default('pending') }}"></span>
                III. Metadata & File Setup
            </summary>
            <div class="stage-content">
                <p>Create the `.md` file and populate YAML front matter (Title, Subtitle, Description, Date, Author Key, Tags, Content Placeholders).</p>
                <p>
                    <strong>Overall Status:</strong> <code class="status-text">{{ status.stages.metadata.status | default('pending') }}</code>
                     {% set current_status = status.stages.metadata.status | default('pending') %}
                     {% if current_status != 'complete' %}<button class="status-update-button" data-slug="{{ slug }}" data-stage="metadata" data-new-status="complete" title="Mark this stage as fully complete">Mark Complete</button>{% endif %}
                     {% if current_status != 'pending' %}<button class="status-update-button" data-slug="{{ slug }}" data-stage="metadata" data-new-status="pending" title="Reset status to pending">Mark Pending</button>{% endif %}
                </p>
                <p><strong>Front Matter Populated:</strong> <span class="traffic-light" data-status="{{ status.stages.metadata.front_matter_status | default('pending') }}"></span> <code class="status-text">{{ status.stages.metadata.front_matter_status | default('pending') }}</code></p>
                <p><strong>Tags Defined:</strong> <span class="traffic-light" data-status="{{ status.stages.metadata.tags_status | default('pending') }}"></span> <code class="status-text">{{ status.stages.metadata.tags_status | default('pending') }}</code></p>
                <p><strong>Author Assigned:</strong> <span class="traffic-light" data-status="{{ status.stages.metadata.author_status | default('pending') }}"></span> <code class="status-text">{{ status.stages.metadata.author_status | default('pending') }}</code></p>
                 <p><i>Title: {{ metadata.title }}</i> | <i>Author Key: {{ metadata.author }}</i> | <i>Tags: {{ metadata.tags | join(', ') }}</i></p>
            </div>
        </details>

        {# --- Stage IV: Image Workflow --- #}
        <details class="workflow-stage" data-stage-key="images">
            <summary>
                <span class="traffic-light" data-status="{{ status.stages.images.status | default('pending') }}"></span>
                IV. Image Workflow
            </summary>
            <div class="stage-content">
                <p>Define prompts, generate/select, rename/place, watermark (optional), integrate paths/alt/captions.</p>
                 <p>
                     <strong>Overall Status:</strong> <code class="status-text">{{ status.stages.images.status | default('pending') }}</code>
                     {% set current_status = status.stages.images.status | default('pending') %}
                     {% if current_status != 'complete' %}<button class="status-update-button" data-slug="{{ slug }}" data-stage="images" data-new-status="complete" title="Mark this stage as fully complete">Mark Complete</button>{% endif %}
                     {% if current_status != 'pending' %}<button class="status-update-button" data-slug="{{ slug }}" data-stage="images" data-new-status="pending" title="Reset status to pending">Mark Pending</button>{% endif %}
                 </p>
                 <p><strong>Prompts Defined:</strong> <span class="traffic-light" data-status="{{ status.stages.images.prompts_defined_status | default('pending') }}"></span> <code class="status-text">{{ status.stages.images.prompts_defined_status | default('pending') }}</code></p>
                 <p><strong>Image Generation/Selection:</strong> <span class="traffic-light" data-status="{{ status.stages.images.generation_status | default('pending') }}"></span> <code class="status-text">{{ status.stages.images.generation_status | default('pending') }}</code></p>
                 <p><strong>Assets Prepared (Renamed/Placed):</strong> <span class="traffic-light" data-status="{{ status.stages.images.assets_prepared_status | default('pending') }}"></span> <code class="status-text">{{ status.stages.images.assets_prepared_status | default('pending') }}</code></p>
                 <p><strong>Metadata Integrated (src/alt/caption):</strong> <span class="traffic-light" data-status="{{ status.stages.images.metadata_integrated_status | default('pending') }}"></span> <code class="status-text">{{ status.stages.images.metadata_integrated_status | default('pending') }}</code></p>
                 <p><strong>Watermarking Status:</strong> <span class="traffic-light" data-status="{{ status.stages.images.watermarking_status | default('pending') }}"></span> <code class="status-text">{{ status.stages.images.watermarking_status | default('pending') }}</code></p> {# Watermarking sub-status #}
                 {# Add button to trigger watermark script later #}
            </div>
        </details>

        {# --- Stage V: Local Validation --- #}
        <details class="workflow-stage" data-stage-key="validation">
            <summary>
                <span class="traffic-light" data-status="{{ status.stages.validation.status | default('pending') }}"></span>
                V. Local Validation
            </summary>
            <div class="stage-content">
                <p>Run `npm start` and preview the post locally at `http://localhost:8080/{{ slug }}/`. Check everything thoroughly.</p>
                <p>
                    <strong>Status:</strong> <code class="status-text">{{ status.stages.validation.status | default('pending') }}</code>
                     {% set current_status = status.stages.validation.status | default('pending') %}
                     {% if current_status != 'complete' %}<button class="status-update-button" data-slug="{{ slug }}" data-stage="validation" data-new-status="complete" title="Mark this stage as fully complete">Mark Complete</button>{% endif %}
                     {% if current_status != 'pending' %}<button class="status-update-button" data-slug="{{ slug }}" data-stage="validation" data-new-status="pending" title="Reset status to pending">Mark Pending</button>{% endif %}
                </p>
                <p><strong>Last Preview OK:</strong> {{ 'Yes' if status.stages.validation.last_preview_ok else 'No / Not Yet Run' }}</p>
                 {# Add button to mark preview OK later #}
            </div>
        </details>

        {# --- Stage VI: Publishing (Clan.com) --- #}
        <details class="workflow-stage" data-stage-key="publishing_clancom">
            <summary>
                <span class="traffic-light" data-status="{{ status.stages.publishing_clancom.status | default('pending') }}"></span>
                VI. Publishing (Clan.com)
            </summary>
            <div class="stage-content">
                <p>Uses the interface button to run `post_to_clan.py` script.</p>
                <p>
                    <strong>Status:</strong> <code class="status-text">{{ status.stages.publishing_clancom.status | default('pending') }}</code>
                     {# Maybe add button to reset to pending if needed? #}
                     {% if status.stages.publishing_clancom.status == 'complete' or status.stages.publishing_clancom.status == 'error' %}
                         <button class="status-update-button" data-slug="{{ slug }}" data-stage="publishing_clancom" data-new-status="pending" title="Reset status to allow re-publishing">Mark Pending</button>
                     {% endif %}
                </p>
                <p><strong>Clan.com Post ID:</strong> <code>{{ status.stages.publishing_clancom.post_id | default('N/A') }}</code></p>
                <p><strong>Last Attempt:</strong> {{ status.stages.publishing_clancom.last_publish_attempt | default('N/A') }}</p>
                <p><strong>Last Error:</strong> <code style="color: red;">{{ status.stages.publishing_clancom.last_error | default('None') }}</code></p>
                <p>
                     <button class="publish-clan-button" data-slug="{{ slug }}">Publish/Update Clan.com Now</button>
                     <a href="README.md#publishing-to-clancom-via-admin-interface" target="_blank" title="Documentation">(?)</a>
                 </p>
                {% if status.stages.publishing_clancom.post_id %}
                    <p><a href="https://clan.com/blog/{{ slug }}.html" target="_blank">View Live Post (Check URL structure)</a></p>
                {% endif %}
            </div>
        </details>

        {# --- Stage VII: Social Media Syndication (was VIII) --- #}
        <details class="workflow-stage" data-stage-key="syndication">
            <summary>
                <span class="traffic-light" data-status="{{ status.stages.syndication.status | default('pending') }}"></span>
                VII. Social Media Syndication (Future)
            </summary>
            <div class="stage-content">
                <p>Prepare platform-specific content and run the syndication script.</p>
                <p>
                    <strong>Overall Status:</strong> <code class="status-text">{{ status.stages.syndication.status | default('pending') }}</code>
                     {% set current_status = status.stages.syndication.status | default('pending') %}
                     {% if current_status != 'complete' %}<button class="status-update-button" data-slug="{{ slug }}" data-stage="syndication" data-new-status="complete" title="Mark this stage as fully complete">Mark Complete</button>{% endif %}
                     {% if current_status != 'pending' %}<button class="status-update-button" data-slug="{{ slug }}" data-stage="syndication" data-new-status="pending" title="Reset status to pending">Mark Pending</button>{% endif %}
                </p>
                <p><strong>Instagram:</strong> <span class="traffic-light" data-status="{{ status.stages.syndication.instagram.overall_status | default('pending') }}"></span> <code class="status-text">{{ status.stages.syndication.instagram.overall_status | default('pending') }}</code></p>
                <p><strong>Facebook:</strong> <span class="traffic-light" data-status="{{ status.stages.syndication.facebook.overall_status | default('pending') }}"></span> <code class="status-text">{{ status.stages.syndication.facebook.overall_status | default('pending') }}</code></p>
                 {# Add buttons/status details later #}
            </div>
        </details>

    </section>

    <section id="log-section" style="margin-top: 30px;">
        <h2>Action Log / Output</h2>
        <pre id="log-output" style="border: 1px solid #eee; background-color: #f8f8f8; min-height: 100px; padding: 10px; white-space: pre-wrap; font-family: monospace; font-size: 0.9em; max-height: 300px; overflow-y: auto;">(Action output will appear here)</pre>
    </section>

    <!-- JavaScript for interactions -->
    <script>
        const logOutput = document.getElementById('log-output');
        const workflowStagesContainer = document.getElementById('workflow-stages'); // Changed target slightly

        // --- Log Message Function ---
        function logMessage(message, isError = false) { /* ... same as before ... */ }

        // --- Event Listener for Action Buttons (Publish) ---
        document.body.addEventListener('click', function(event) { // Use body to catch all clicks
            if (event.target.matches('.publish-clan-button')) {
                // ... (publish button logic remains the same) ...
            }
            // --- NEW: Handle Status Update Button Clicks ---
            else if (event.target.matches('.status-update-button')) {
                const button = event.target;
                const slug = button.dataset.slug;
                const stageKey = button.dataset.stage;
                const newStatus = button.dataset.newStatus;

                if (!slug || !stageKey || !newStatus) {
                    logMessage("Error: Missing data attributes on status button.", true);
                    return;
                }

                logMessage(`Updating status for '${slug}/${stageKey}' to '${newStatus}'...`);
                button.disabled = true; // Disable button during processing

                fetch(`/api/update_status/${slug}/${stageKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus }) // Send new status in body
                })
                .then(response => {
                    if (!response.ok) { throw new Error(`HTTP error ${response.status}`); }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        logMessage(`Status updated successfully for '${data.slug}/${data.stage}' to '${data.new_status}'.`);
                        // --- Dynamic UI Update ---
                        // Find the corresponding traffic light and status text and update them
                        const stageElement = document.querySelector(`.workflow-stage[data-stage-key="${data.stage}"]`);
                        if (stageElement) {
                            const trafficLight = stageElement.querySelector(`summary .traffic-light`);
                            const statusText = stageElement.querySelector(`.stage-content .status-text`); // Assuming first status text is overall
                            if (trafficLight) trafficLight.dataset.status = data.new_status;
                            if (statusText) statusText.textContent = data.new_status;

                            // Update buttons visibility/text (needs page reload for simplicity now)
                            // OR more complex JS to swap buttons dynamically
                            logMessage("Reloading page to reflect button changes...");
                            window.location.reload(); // Simple way to update buttons for now
                        }
                        // --- End Dynamic UI Update ---
                    } else {
                        logMessage(`Error updating status: ${data.message}`, true);
                        alert(`Error updating status: ${data.message}`); // Also alert user
                    }
                })
                .catch(error => {
                    logMessage(`Error during status update fetch for '${slug}/${stageKey}': ${error.message}`, true);
                    console.error('Fetch Error:', error);
                })
                .finally(() => {
                    // Re-enable button (it will be correct after reload anyway)
                     button.disabled = false;
                });
            }
            // --- END Handle Status Update ---

            // --- Handle Help Trigger Clicks (from previous step) ---
            else if (event.target.matches('.help-trigger')) {
                // ... (help trigger logic remains the same) ...
            }
            // --- Handle clicking outside help ---
            else if (!event.target.closest('.help-content') && !event.target.matches('.help-trigger')) {
                 document.querySelectorAll('.help-content.active').forEach(activeHelp => {
                      activeHelp.classList.remove('active');
                 });
            }
        });

        console.log("Admin interface loaded.");
    </script>

</body>
</html>